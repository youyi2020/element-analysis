# 对上下游请求header的处理

对于HTTP协议，zipkin通过在请求的头部添加X-B3-TraceId、X-B3-SpanId、X-B3-ParentSpanId、X-B3-Sampled、X-B3-Flags项在调用链各系统之间传递追踪信息，其中：

1. trace：表示对一次用户请求的追踪，一次用户请求可能经过多个不同服务的处理，trace是这些处理过程的追踪信息的集合
2. span：表示某个服务对请求的处理，是追踪信息的基本单元

这里的traceId和spanId即为trace和span的id。parentSpanId表示当前span的父span，即调用直接本次服务的上游服务对应的span。sampled表示当前span是否需要被采样，0表示不采样，1表示采样，一般对于需要追踪的系统设置为1即可。flags主要用于系统调试，正式使用时一般不需要设置。

```java
String traceId=request.getHeader("x-b3-tracdid");
String spanId=request.getHeader("x-b3-spanid");
String parentSpanId=request.getHeader("x-b3-parentspanid");
String sampled=request.getHeader("x-b3-sampled");
```

若当前服务不是整个追踪链的第一个请求，则需要代表当前服务的span，并为每一个直接下游服务生成span；若当前服务为第一个请求，除需要生成span外还需要生成trace。

以下是一个span对应的json格式日志的例子：

```json
[
  {
    "traceId": "5baf005d99ec16749194736bf61f6ecf",
    "parentId": "9194736bf61f6ecf",
    "id": "825a76189e4f11cb",
    "kind": "CLIENT",
    "name": "get",
    "timestamp": 1538195550237428,
    "duration": 417021,
    "localEndpoint": {
      "serviceName": "caller",
      "ipv4": "172.16.182.71"
    },
    "tags": {
      "http.method": "GET",
      "http.path": "/aa",
      "requestFrom": "caller",
      "upstreamDevice": "zx-CW15@127.0.1.1"
    }
  },
  {
    "traceId": "5baf005d99ec16749194736bf61f6ecf",
    "id": "9194736bf61f6ecf",
    "kind": "SERVER",
    "name": "get /hi",
    "timestamp": 1538195549994285,
    "duration": 749953,
    "localEndpoint": {
      "serviceName": "caller",
      "ipv4": "172.16.182.71"
    },
    "remoteEndpoint": {
      "ipv6": "::1",
      "port": 49170
    },
    "tags": {
      "http.method": "GET",
      "http.path": "/hi",
      "mvc.controller.class": "CallerController",
      "mvc.controller.method": "hi"
    }
  }
]
```

id和parentId分别表示spanId和parentSpanId。

kind：表示当前服务是作为服务端（SERVER）还是客户端（CLIENT）。

name：表示当前span的名字，使用便于分辨的名称即可，一般使用http method及所调用的端口。

timestamp：span创建的时间戳，需要注意的是单位为微秒（10^-6秒）。

duration：span持续的时间，单位同样为微秒，需要注意，上游系统span的duration包括在该span中调用下游系统并返回的时间，例如A系统运行300ms后调用B系统，B系统100ms后返回结果，则A系统该span的duration为400ms（网络传输时间也包括在内）。

localEndpoint：当前节点信息。

remoteEndpoint：远程节点的信息。

localEndpoint和remoteEndpoint中的ip信息可以使用ipv4或ipv6。

tags：需要额外记录的数据，一般包括http method及http path，可自行添加其他数据项。

# traceId和spanId的生成规则

traceId生成规则：32位长的16进制字符串，可以使用UUID（需要去掉其中的连字符）
```java
String traceId=UUID.randomUUID().toString().replaceAll("-","");
```
spanId生成规则：16位长的16进制字符串，可以使用UUID的一半，其中，每个trace首个span的spanId应与traceId的低16位相同并且没有parentId
```java
String spanId=UUID.randomUUID().toString().replaceAll("-","").subString(16);
```
parentId：直接采用当前span的父span（即调用当次服务的上游服务对应的span）的id

# 记录日志

将上述json化后的追踪日志写入日志文件（默认位置为/opt/his/trace目录下，文件名格式为“[当前服务名称]-logfile-yyyy-MM-dd.log”），之后由运维统一导入到kafka中，由zipkin-server统一从kafka读取后处理。